



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-5.5.14">
    
    
      
        <title>The Functions - Clinical Costing</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d3202873.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-functions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Clinical Costing" class="md-header-nav__button md-logo" aria-label="Clinical Costing">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Clinical Costing
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              The Functions
            
          </span>
        </div>
      
    </div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Clinical Costing" class="md-nav__button md-logo" aria-label="Clinical Costing">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Clinical Costing
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../how-to-guide/" title="How-To Guide" class="md-nav__link">
      How-To Guide
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../theProcess/" title="The Clinical Costing Process" class="md-nav__link">
      The Clinical Costing Process
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../theDatabase/" title="The Database design" class="md-nav__link">
      The Database design
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        The Functions
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="The Functions" class="md-nav__link md-nav__link--active">
      The Functions
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-general-functions" class="md-nav__link">
    The General Functions
  </a>
  
    <nav class="md-nav" aria-label="The General Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.addCommonArguments" class="md-nav__link">
    addCommonArguments()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.addTableData" class="md-nav__link">
    addTableData()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.checkWorksheet" class="md-nav__link">
    checkWorksheet()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.createEngine" class="md-nav__link">
    createEngine()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.generalLedgerAdjustOrMap" class="md-nav__link">
    generalLedgerAdjustOrMap()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.moveCosts" class="md-nav__link">
    moveCosts()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.setupLogging" class="md-nav__link">
    setupLogging()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-build-clinical-events-functions" class="md-nav__link">
    The Build Clinical Events Functions
  </a>
  
    <nav class="md-nav" aria-label="The Build Clinical Events Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build_events_functions" class="md-nav__link">
    build_events_functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDadmissions" class="md-nav__link">
    EDadmissions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDattendmin" class="md-nav__link">
    EDattendmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDdischarges" class="md-nav__link">
    EDdischarges()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDseenmin" class="md-nav__link">
    EDseenmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDtreatmin" class="md-nav__link">
    EDtreatmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.adjustAcuity" class="md-nav__link">
    adjustAcuity()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.anaesthmin" class="md-nav__link">
    anaesthmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.baseParams" class="md-nav__link">
    baseParams()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.buildEvent" class="md-nav__link">
    buildEvent()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.checkDistributionCode" class="md-nav__link">
    checkDistributionCode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipadmissions" class="md-nav__link">
    ipadmissions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipdischarges" class="md-nav__link">
    ipdischarges()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipwardbdays" class="md-nav__link">
    ipwardbdays()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipwardbhrs" class="md-nav__link">
    ipwardbhrs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipwardsday" class="md-nav__link">
    ipwardsday()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.opclinicmin" class="md-nav__link">
    opclinicmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.theatremin" class="md-nav__link">
    theatremin()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-general-functions" class="md-nav__link">
    The General Functions
  </a>
  
    <nav class="md-nav" aria-label="The General Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.addCommonArguments" class="md-nav__link">
    addCommonArguments()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.addTableData" class="md-nav__link">
    addTableData()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.checkWorksheet" class="md-nav__link">
    checkWorksheet()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.createEngine" class="md-nav__link">
    createEngine()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.generalLedgerAdjustOrMap" class="md-nav__link">
    generalLedgerAdjustOrMap()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.moveCosts" class="md-nav__link">
    moveCosts()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions.setupLogging" class="md-nav__link">
    setupLogging()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-build-clinical-events-functions" class="md-nav__link">
    The Build Clinical Events Functions
  </a>
  
    <nav class="md-nav" aria-label="The Build Clinical Events Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#build_events_functions" class="md-nav__link">
    build_events_functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDadmissions" class="md-nav__link">
    EDadmissions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDattendmin" class="md-nav__link">
    EDattendmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDdischarges" class="md-nav__link">
    EDdischarges()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDseenmin" class="md-nav__link">
    EDseenmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.EDtreatmin" class="md-nav__link">
    EDtreatmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.adjustAcuity" class="md-nav__link">
    adjustAcuity()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.anaesthmin" class="md-nav__link">
    anaesthmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.baseParams" class="md-nav__link">
    baseParams()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.buildEvent" class="md-nav__link">
    buildEvent()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.checkDistributionCode" class="md-nav__link">
    checkDistributionCode()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipadmissions" class="md-nav__link">
    ipadmissions()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipdischarges" class="md-nav__link">
    ipdischarges()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipwardbdays" class="md-nav__link">
    ipwardbdays()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipwardbhrs" class="md-nav__link">
    ipwardbhrs()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.ipwardsday" class="md-nav__link">
    ipwardsday()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.opclinicmin" class="md-nav__link">
    opclinicmin()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build_events_functions.theatremin" class="md-nav__link">
    theatremin()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="the-functions">The Functions</h1>
<h2 id="the-general-functions">The General Functions</h2>


<div class="doc doc-object doc-module">



<a id="functions"></a>
  <div class="doc doc-contents first">
  
      <p>The common functions for the Clinical Costing system.</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="functions.addCommonArguments" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">addCommonArguments</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Add the common command line arguments</p>

          <details class="quote">
            <summary>Source code in <code>functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">addCommonArguments</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add the common command line arguments</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-C&#39;</span><span class="p">,</span> <span class="s1">&#39;--configDir&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;configDir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;databaseConfig&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The name of the directory containing the database connection configuration file (default=config)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--configFile&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;configFile&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;clinical_costing.json&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The name of the configuration file (default clinical_costing.json)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-D&#39;</span><span class="p">,</span> <span class="s1">&#39;--DatabaseType&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;DatabaseType&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MSSQL&#39;</span><span class="p">,</span> <span class="s1">&#39;MySQL&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The Database Type [choices: MSSQL/MySQL]&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--server&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;server&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The address of the database server&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--username&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The user required to access the database&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--password&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The user password required to access the database&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--databaseName&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;databaseName&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The name of the database&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The level of logging</span><span class="se">\n\t</span><span class="s1">0=CRITICAL,1=ERROR,2=WARNING,3=INFO,4=DEBUG&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s1">&#39;-L&#39;</span><span class="p">,</span> <span class="s1">&#39;--logDir&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;logDir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;logDir&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The name of the directory where the logging file will be created&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span> <span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--logFile&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;logFile&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;logfile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The name of a logging file&#39;</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="functions.addTableData" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">addTableData</span><span class="p">(</span><span class="n">dfTable</span><span class="p">,</span> <span class="n">thisTable</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Add data from a dataframe to a database table</p>

          <details class="quote">
            <summary>Source code in <code>functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">addTableData</span><span class="p">(</span><span class="n">dfTable</span><span class="p">,</span> <span class="n">thisTable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Add data from a dataframe to a database table</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Process each row of the spreadsheet, doing an update or an append</span>
    <span class="c1"># [Deletes are not supported as they could break the referrential integrety of exising data]</span>
    <span class="c1"># Collect all the indexed columns - assume that there are foreign keys associated with these</span>
    <span class="n">indexedColumns</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">thisTable</span><span class="p">]</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">indexedColumns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">indexedColumns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c1"># Process each row</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dfTable</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">where</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Build a where clause, based on the values of the primary key and indexed columns</span>
        <span class="n">foundCols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">indexedColumns</span><span class="p">:</span>
            <span class="n">foundCols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">where</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span>
            <span class="n">where</span> <span class="o">+=</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39; = &quot;&#39;</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">thisTable</span><span class="p">]</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">colName</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">colName</span> <span class="ow">in</span> <span class="n">indexedColumns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">colName</span> <span class="ow">in</span> <span class="n">foundCols</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">foundCols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">colName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">where</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">colName</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">where</span> <span class="o">+=</span> <span class="n">colName</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">where</span> <span class="o">+=</span> <span class="n">colName</span> <span class="o">+</span> <span class="s1">&#39; = &quot;&#39;</span> <span class="o">+</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">where</span> <span class="o">+=</span> <span class="n">colName</span> <span class="o">+</span> <span class="s1">&#39; = &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">thisTable</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">where</span><span class="p">)))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;table(</span><span class="si">%s</span><span class="s2">), where(</span><span class="si">%s</span><span class="s2">), results(</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">thisTable</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>

        <span class="c1"># Assemble the parameters (values to be updated, or inserted)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">thisTable</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">colName</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">colName</span> <span class="ow">in</span> <span class="n">indexedColumns</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">param</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">colName</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">param</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="n">colName</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>      <span class="c1"># A row exists</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>       <span class="c1"># Which has updatable columns (not part of primary key or foreign key)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Existing row update: updating table </span><span class="si">%s</span><span class="s1">, with values </span><span class="si">%s</span><span class="s1">, where </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">thisTable</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">thisTable</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">where</span><span class="p">)))</span>
                    <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;New row: inserting into table </span><span class="si">%s</span><span class="s1"> value </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">thisTable</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">thisTable</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="functions.checkWorksheet" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">checkWorksheet</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">toBeAdded</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Check that a worksheet exist in the workbook and that the name of the sheet matches a database table,
and that the sheet has column headings that match the database table column names,
and that the data in this sheet matches the defined datatype for the columns in the table.</p>

          <details class="quote">
            <summary>Source code in <code>functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">checkWorksheet</span><span class="p">(</span><span class="n">wb</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">toBeAdded</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check that a worksheet exist in the workbook and that the name of the sheet matches a database table,</span>
<span class="sd">    and that the sheet has column headings that match the database table column names,</span>
<span class="sd">    and that the data in this sheet matches the defined datatype for the columns in the table.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Check that this worksheet exits</span>
    <span class="k">if</span> <span class="n">sheet</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">wb</span><span class="o">.</span><span class="n">sheetnames</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;No sheet name &quot;</span><span class="si">%s</span><span class="s1">&quot; in workbook&#39;</span><span class="p">,</span> <span class="n">sheet</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Missing database table &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>

    <span class="c1"># Check this worksheet</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="n">sheet</span><span class="p">]</span>

    <span class="c1"># Make sure every column in the this worksheet matches a column name in this table</span>
    <span class="c1"># and that every cell has data of the correct data type</span>
    <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">ws</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">heading</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">col</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">heading</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Invalid heading &quot;</span><span class="si">%s</span><span class="s1">&quot; (not string) in worksheet &quot;</span><span class="si">%s</span><span class="s1">&quot; at &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
                <span class="n">colName</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">value</span>
                <span class="k">if</span> <span class="n">colName</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colName</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Extraneous column &quot;</span><span class="si">%s</span><span class="s1">&quot; in worksheet &quot;</span><span class="si">%s</span><span class="s1">&quot; at &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">colName</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
                <span class="n">colType</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">colName</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">python_type</span>
                <span class="n">heading</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">colType</span><span class="p">):</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">colType</span> <span class="o">==</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">colType</span> <span class="o">==</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">)):</span>
                    <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">colType</span> <span class="o">==</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
                        <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">colType</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                                <span class="n">failed</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">if</span> <span class="n">failed</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Invalid data &quot;</span><span class="si">%s</span><span class="s1">&quot; (type </span><span class="si">%s</span><span class="s1"> not </span><span class="si">%s</span><span class="s1">) in column &quot;</span><span class="si">%s</span><span class="s1">&quot; in worksheet &quot;</span><span class="si">%s</span><span class="s1">&quot; at &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                                    <span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">colType</span><span class="p">,</span> <span class="n">colName</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">cell</span><span class="o">.</span><span class="n">coordinate</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>

    <span class="c1"># Check that every column in the database table has a column in the worksheet</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">toBeAdded</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Database column (</span><span class="si">%s</span><span class="s1">) in table &quot;</span><span class="si">%s</span><span class="s1">&quot; not found in sheet &quot;</span><span class="si">%s</span><span class="s1">&quot; headers&#39;</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">sheet</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>

    <span class="c1"># Check any codes that need to be in a code table</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">values</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">table_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">foreign_key</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">foreign_key_constraints</span><span class="p">:</span>
        <span class="n">codeColumn</span> <span class="o">=</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">column_keys</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">codeColumn</span> <span class="ow">in</span> <span class="n">toBeAdded</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Get all the referred to codesets</span>
        <span class="n">refered_table</span> <span class="o">=</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">referred_table</span>
        <span class="k">if</span> <span class="n">refered_table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">:</span>     <span class="c1"># A new codeset, add it to the dictionary of codesets</span>
            <span class="n">selectText</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT </span><span class="si">{</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">target_fullname</span><span class="si">}</span><span class="s1"> FROM </span><span class="si">{</span><span class="n">foreign_key</span><span class="o">.</span><span class="n">referred_table</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">where</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">column_key</span> <span class="ow">in</span> <span class="n">foreign_key</span><span class="o">.</span><span class="n">column_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">column_key</span> <span class="o">==</span> <span class="s1">&#39;hospital_code&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">where</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span>
                    <span class="n">where</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="k">if</span> <span class="n">column_key</span> <span class="o">==</span> <span class="s1">&#39;run_code&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">where</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span>
                    <span class="n">where</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
                <span class="k">if</span> <span class="n">column_key</span> <span class="o">==</span> <span class="s1">&#39;model_code&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">where</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span>
                    <span class="n">where</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;model_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">model_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
            <span class="k">if</span> <span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; WHERE &#39;</span> <span class="o">+</span> <span class="n">where</span>
            <span class="n">selected_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
            <span class="n">codes</span> <span class="o">=</span> <span class="n">selected_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>      <span class="c1"># convert rows/columns to a list of lists (will be [[code]] )</span>
            <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="n">refered_table</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">codeRow</span> <span class="ow">in</span> <span class="n">codes</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="n">refered_table</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">codeRow</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Check every foreign key value to make sure that it is in the matching codeset</span>
        <span class="k">for</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">table_df</span><span class="p">[</span><span class="n">codeColumn</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="n">refered_table</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Code &quot;</span><span class="si">%s</span><span class="s1">&quot; in worksheet &quot;</span><span class="si">%s</span><span class="s1">&quot; is not in database code table &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">sheet</span><span class="p">,</span> <span class="n">refered_table</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;table codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="n">refered_table</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_DATAERR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table_df</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="functions.createEngine" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">createEngine</span><span class="p">(</span><span class="n">configDir</span><span class="p">,</span> <span class="n">configFile</span><span class="p">,</span> <span class="n">DatabaseType</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">databaseName</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Parse the config file and create the database engine and session maker</p>

          <details class="quote">
            <summary>Source code in <code>functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">createEngine</span><span class="p">(</span><span class="n">configDir</span><span class="p">,</span> <span class="n">configFile</span><span class="p">,</span> <span class="n">DatabaseType</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">databaseName</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parse the config file and create the database engine and session maker</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c1"># The configuration data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">configDir</span><span class="p">,</span> <span class="n">configFile</span><span class="p">),</span> <span class="s1">&#39;rt&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configSource</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">configSource</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;configFile (</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">) failed to load&#39;</span><span class="p">,</span> <span class="n">configDir</span><span class="p">,</span> <span class="n">configFile</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>

    <span class="c1"># Check that we have a databaseName if we have a databaseType</span>
    <span class="k">if</span> <span class="n">DatabaseType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;DatabaseType(</span><span class="si">%s</span><span class="s1">) not found in configuraton file(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">DatabaseType</span><span class="p">,</span> <span class="n">configFile</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_USAGE</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;connectionString&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> connectionString defined in configuration file(SQLAlchemyDB.json)&#39;</span><span class="p">,</span> <span class="n">DatabaseType</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="n">connectionString</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">][</span><span class="s1">&#39;connectionString&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">][</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;password&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">][</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;server&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">][</span><span class="s1">&#39;server&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;databaseName&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">databaseName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">databaseName</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">DatabaseType</span><span class="p">][</span><span class="s1">&#39;databaseName&#39;</span><span class="p">]</span>

    <span class="c1"># Check that we have all the required paramaters</span>
    <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Missing definition for &quot;username&quot;&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_USAGE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">password</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Missing definition for &quot;password&quot;&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_USAGE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Missing definition for &quot;server&quot;&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_USAGE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">databaseName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Missing definition for &quot;databaseName&quot;&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_USAGE</span><span class="p">)</span>
    <span class="n">connectionString</span> <span class="o">=</span> <span class="n">connectionString</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="n">databaseName</span><span class="o">=</span><span class="n">databaseName</span><span class="p">)</span>

    <span class="c1"># Create the engine</span>
    <span class="k">if</span> <span class="n">DatabaseType</span> <span class="o">==</span> <span class="s1">&#39;MSSQL&#39;</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">connectionString</span><span class="p">,</span> <span class="n">use_setinputsizes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">connectionString</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Check if the database exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Database </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="n">databaseName</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>

    <span class="c1"># Connect to the database</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">OperationalError</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Connection error for database </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">databaseName</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_UNAVAILABLE</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Connection error for database </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">databaseName</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_UNAVAILABLE</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Now get the metadata and build a session maker</span>
    <span class="n">d</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="functions.generalLedgerAdjustOrMap" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">generalLedgerAdjustOrMap</span><span class="p">(</span><span class="n">adjustMap_df</span><span class="p">,</span> <span class="n">costs_df</span><span class="p">,</span> <span class="n">preservedCostTypes</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Execute any adjustments or mappings</p>

          <details class="quote">
            <summary>Source code in <code>functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generalLedgerAdjustOrMap</span><span class="p">(</span><span class="n">adjustMap_df</span><span class="p">,</span> <span class="n">costs_df</span><span class="p">,</span> <span class="n">preservedCostTypes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Execute any adjustments or mappings</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">thisRow</span> <span class="ow">in</span> <span class="n">adjustMap_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">thisFromDeptCode</span> <span class="o">=</span> <span class="n">thisRow</span><span class="o">.</span><span class="n">from_department_code</span>
        <span class="n">thisFromCostType</span> <span class="o">=</span> <span class="n">thisRow</span><span class="o">.</span><span class="n">from_cost_type_code</span>
        <span class="n">thisMappingCode</span> <span class="o">=</span> <span class="n">thisRow</span><span class="o">.</span><span class="n">mapping_type_code</span>
        <span class="n">thisAmount</span> <span class="o">=</span> <span class="n">thisRow</span><span class="o">.</span><span class="n">amount</span>
        <span class="n">thisToDeptCode</span> <span class="o">=</span> <span class="n">thisRow</span><span class="o">.</span><span class="n">to_department_code</span>
        <span class="n">thisToCostType</span> <span class="o">=</span> <span class="n">thisRow</span><span class="o">.</span><span class="n">to_cost_type_code</span>
        <span class="n">preservedCostTypes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">thisToCostType</span><span class="p">)</span>
        <span class="n">costs_df</span> <span class="o">=</span> <span class="n">moveCosts</span><span class="p">(</span><span class="n">thisFromDeptCode</span><span class="p">,</span> <span class="n">thisFromCostType</span><span class="p">,</span> <span class="n">thisAmount</span><span class="p">,</span> <span class="n">thisToDeptCode</span><span class="p">,</span> <span class="n">thisToCostType</span><span class="p">,</span> <span class="n">thisMappingCode</span><span class="p">,</span> <span class="n">costs_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">costs_df</span><span class="p">,</span> <span class="n">preservedCostTypes</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="functions.moveCosts" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">moveCosts</span><span class="p">(</span><span class="n">fromDeptCode</span><span class="p">,</span> <span class="n">fromCostType</span><span class="p">,</span> <span class="n">toAmount</span><span class="p">,</span> <span class="n">toDeptCode</span><span class="p">,</span> <span class="n">toCostType</span><span class="p">,</span> <span class="n">mappingCode</span><span class="p">,</span> <span class="n">dfCosts</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Move a cost from one account to another</p>

          <details class="quote">
            <summary>Source code in <code>functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">moveCosts</span><span class="p">(</span><span class="n">fromDeptCode</span><span class="p">,</span> <span class="n">fromCostType</span><span class="p">,</span> <span class="n">toAmount</span><span class="p">,</span> <span class="n">toDeptCode</span><span class="p">,</span> <span class="n">toCostType</span><span class="p">,</span> <span class="n">mappingCode</span><span class="p">,</span> <span class="n">dfCosts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Move a cost from one account to another</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">dfFromCost</span> <span class="o">=</span> <span class="n">dfCosts</span><span class="p">[(</span><span class="n">dfCosts</span><span class="p">[</span><span class="s1">&#39;department_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fromDeptCode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfCosts</span><span class="p">[</span><span class="s1">&#39;cost_type_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fromCostType</span><span class="p">)]</span>
    <span class="n">dfToCost</span> <span class="o">=</span> <span class="n">dfCosts</span><span class="p">[(</span><span class="n">dfCosts</span><span class="p">[</span><span class="s1">&#39;department_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">toDeptCode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfCosts</span><span class="p">[</span><span class="s1">&#39;cost_type_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">toCostType</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfFromCost</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>       <span class="c1"># Has to be something to move</span>
        <span class="n">oldFromAmount</span> <span class="o">=</span> <span class="n">dfFromCost</span><span class="p">[</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mappingCode</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>        <span class="c1"># This is a fractional cost (thisAmount is actually a fraction, not a cost)</span>
            <span class="n">toAmount</span> <span class="o">=</span> <span class="n">oldFromAmount</span> <span class="o">*</span> <span class="n">toAmount</span>

        <span class="c1">#Check to see if this  requires a new thisRow</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dfToCost</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">newRow</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hospital_code&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="p">,</span> <span class="s1">&#39;run_code&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="p">,</span> <span class="s1">&#39;model_code&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">model_code</span><span class="p">,</span> <span class="s1">&#39;department_code&#39;</span><span class="p">:</span> <span class="n">toDeptCode</span><span class="p">,</span> <span class="s1">&#39;cost_type_code&#39;</span><span class="p">:</span> <span class="n">toCostType</span><span class="p">,</span> <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="n">toAmount</span><span class="p">}</span>
            <span class="n">dfCosts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dfCosts</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">newRow</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfCosts</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dfCosts</span><span class="o">.</span><span class="n">department_code</span> <span class="o">==</span> <span class="n">toDeptCode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfCosts</span><span class="o">.</span><span class="n">cost_type_code</span> <span class="o">==</span> <span class="n">toCostType</span><span class="p">),</span> <span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">toAmount</span>
        <span class="n">dfCosts</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">dfCosts</span><span class="o">.</span><span class="n">department_code</span> <span class="o">==</span> <span class="n">fromDeptCode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">dfCosts</span><span class="o">.</span><span class="n">cost_type_code</span> <span class="o">==</span> <span class="n">fromCostType</span><span class="p">),</span> <span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">toAmount</span>
    <span class="k">return</span> <span class="n">dfCosts</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="functions.setupLogging" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">setupLogging</span><span class="p">(</span><span class="n">progName</span><span class="p">,</span> <span class="n">logDir</span><span class="p">,</span> <span class="n">logFile</span><span class="p">,</span> <span class="n">loggingLevel</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Set up the logging</p>

          <details class="quote">
            <summary>Source code in <code>functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setupLogging</span><span class="p">(</span><span class="n">progName</span><span class="p">,</span> <span class="n">logDir</span><span class="p">,</span> <span class="n">logFile</span><span class="p">,</span> <span class="n">loggingLevel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Set up the logging</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logging_levels</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">}</span>
    <span class="n">logfmt</span> <span class="o">=</span> <span class="n">progName</span> <span class="o">+</span> <span class="s1">&#39; [</span><span class="si">%(asctime)s</span><span class="s1">]: </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
    <span class="k">if</span> <span class="n">loggingLevel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># Change the logging level from &quot;WARN&quot; if the -v vebose option is specified</span>
        <span class="k">if</span> <span class="n">logFile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>        <span class="c1"># and send it to a file if the -o logfile option is specified</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logDir</span><span class="p">,</span> <span class="n">logFile</span><span class="p">),</span> <span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">logOutput</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">logfmt</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y %H:%M:%S %p&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging_levels</span><span class="p">[</span><span class="n">loggingLevel</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logDir</span><span class="p">,</span> <span class="n">logFile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">logfmt</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y %H:%M:%S %p&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">logging_levels</span><span class="p">[</span><span class="n">loggingLevel</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logFile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>        <span class="c1"># send the default (WARN) logging to a file if the -o logfile option is specified</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logDir</span><span class="p">,</span> <span class="n">logFile</span><span class="p">),</span> <span class="s1">&#39;wt&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">logOutput</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">logfmt</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y %H:%M:%S %p&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logDir</span><span class="p">,</span> <span class="n">logFile</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">logfmt</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%y %H:%M:%S %p&#39;</span><span class="p">)</span>

    <span class="c1"># Set the SQLAlchemy logging level</span>
    <span class="k">if</span> <span class="n">loggingLevel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.engine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging_levels</span><span class="p">[</span><span class="n">loggingLevel</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;sqlalchemy.engine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">)</span>
    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div><h2 id="the-build-clinical-events-functions">The Build Clinical Events Functions</h2>


<div class="doc doc-object doc-module">



<a id="build_events_functions"></a>
  <div class="doc doc-contents first">
  
      <p>The Event building functions for the Clinical Costing system.</p>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="build_events_functions.EDadmissions" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">EDadmissions</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based admissions to the Accidenta and Emergency department</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">EDadmissions</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based admissions to the Accidenta and Emergency department</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;service_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ED&#39;</span>
    <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no FROM ed_admissions WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
    <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.EDattendmin" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">EDattendmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on minutes in the Accident and Emergency department</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">EDattendmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on minutes in the Accident and Emergency department</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;service_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ED&#39;</span>
    <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no, attend_min, acuity FROM ed_episode_details WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
    <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
        <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
        <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">attend_min</span> <span class="o">*</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.EDdischarges" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">EDdischarges</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on discharges from the Accident and Emergency department</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">EDdischarges</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on discharges from the Accident and Emergency department</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;service_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ED&#39;</span>
    <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no FROM ed_discharges WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
    <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.EDseenmin" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">EDseenmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on minutes seen by a nurse the Accident and Emergency department</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">EDseenmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on minutes seen by a nurse the Accident and Emergency department</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;service_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ED&#39;</span>
    <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no, seen_min, acuity FROM ed_episode_details WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
    <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
        <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
        <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">seen_min</span> <span class="o">*</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.EDtreatmin" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">EDtreatmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on minutes of treatment in the Accident and Emergency department</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">EDtreatmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on minutes of treatment in the Accident and Emergency department</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;service_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ED&#39;</span>
    <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no, treat_min, acuity FROM ed_episode_details WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
    <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
        <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
        <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">treat_min</span> <span class="o">*</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.adjustAcuity" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">adjustAcuity</span><span class="p">(</span><span class="n">thisAcuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Adjust acuity, based upon acuity scaling</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">adjustAcuity</span><span class="p">(</span><span class="n">thisAcuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Adjust acuity, based upon acuity scaling</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">acuityScaling</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>        <span class="c1"># Increase the acuity</span>
        <span class="k">if</span> <span class="n">thisAcuity</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>            <span class="c1"># By reducing the reduction</span>
            <span class="n">thisAcuity</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">/</span> <span class="n">acuityScaling</span>
        <span class="k">else</span><span class="p">:</span>                           <span class="c1"># By increasing the increase</span>
            <span class="n">thisAcuity</span> <span class="o">*=</span> <span class="n">acuityScaling</span>
    <span class="k">elif</span> <span class="n">thisAcuity</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>      <span class="c1"># Reduce the acuity by increasing the reduction</span>
        <span class="n">thisAcuity</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">acuityScaling</span>
    <span class="k">else</span><span class="p">:</span>                       <span class="c1"># Reduce the acuity by reducing the increase</span>
        <span class="n">thisAcuity</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">thisAcuity</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">acuityScaling</span>
    <span class="k">return</span> <span class="n">thisAcuity</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.anaesthmin" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">anaesthmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on minutes of anaethesia</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">anaesthmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on minutes of anaethesia</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no, surgery_seq, anaesthetic_mins, theatre_acuity FROM inpat_theatre_details WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
    <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_seq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">surgery_seq</span>
        <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">anaesthetic_mins</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">theatre_acuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.baseParams" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build the base parameters</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build the base parameters</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;hospital_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;run_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">run_code</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">model_code</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_attribute_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attribute</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;service_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Inpat&#39;</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_seq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_what&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">what</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">params</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.buildEvent" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">buildEvent</span><span class="p">(</span><span class="n">eventFunc</span><span class="p">,</span> <span class="n">eventCode</span><span class="p">,</span> <span class="n">eventAttribute</span><span class="p">,</span> <span class="n">eventWhat</span><span class="p">,</span> <span class="n">eventWhere</span><span class="p">,</span> <span class="n">eventBase</span><span class="p">,</span> <span class="n">eventWeight</span><span class="p">,</span> <span class="n">eventAcuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build an Event using the function "eventFunc"</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">buildEvent</span><span class="p">(</span><span class="n">eventFunc</span><span class="p">,</span> <span class="n">eventCode</span><span class="p">,</span> <span class="n">eventAttribute</span><span class="p">,</span> <span class="n">eventWhat</span><span class="p">,</span> <span class="n">eventWhere</span><span class="p">,</span> <span class="n">eventBase</span><span class="p">,</span> <span class="n">eventWeight</span><span class="p">,</span> <span class="n">eventAcuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build an Event using the function &quot;eventFunc&quot;</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">eventFunc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">())</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="nb">globals</span><span class="p">()[</span><span class="n">eventFunc</span><span class="p">]):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;Event function &quot;</span><span class="si">%s</span><span class="s1">&quot; is not defined&#39;</span><span class="p">,</span> <span class="n">eventFunc</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_USAGE</span><span class="p">)</span>
    <span class="nb">globals</span><span class="p">()[</span><span class="n">eventFunc</span><span class="p">](</span><span class="n">eventCode</span><span class="p">,</span> <span class="n">eventAttribute</span><span class="p">,</span> <span class="n">eventWhat</span><span class="p">,</span> <span class="n">eventWhere</span><span class="p">,</span> <span class="n">eventBase</span><span class="p">,</span> <span class="n">eventWeight</span><span class="p">,</span> <span class="n">eventAcuityScaling</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.checkDistributionCode" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">checkDistributionCode</span><span class="p">(</span><span class="n">distributionCode</span><span class="p">,</span> <span class="n">eventCode</span><span class="p">,</span> <span class="n">eventAttribute</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Check a distribution_code and, if necessary, create a new one</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">checkDistributionCode</span><span class="p">(</span><span class="n">distributionCode</span><span class="p">,</span> <span class="n">eventCode</span><span class="p">,</span> <span class="n">eventAttribute</span><span class="p">,</span> <span class="n">unit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Check a distribution_code and, if necessary, create a new one</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">distributionCode</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="n">distributionDescription</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;event_codes&#39;</span><span class="p">][</span><span class="n">eventCode</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;event_attribute_codes&#39;</span><span class="p">][</span><span class="n">eventAttribute</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;ward_codes&#39;</span><span class="p">]:</span>
            <span class="n">distributionDescription</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; for ward (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;ward_codes&#39;</span><span class="p">][</span><span class="n">unit</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;clinic_codes&#39;</span><span class="p">]:</span>
            <span class="n">distributionDescription</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; for clinic (</span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;clinic_codes&#39;</span><span class="p">][</span><span class="n">unit</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;hospital_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;model_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">model_code</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionDescription</span>
    <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">][</span><span class="n">distributionCode</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionDescription</span>
    <span class="k">return</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.ipadmissions" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">ipadmissions</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on admissions to an inpatient ward</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ipadmissions</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on admissions to an inpatient ward</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT inpat_episode_details.episode_no as episode_no, inpat_episode_details.admitting_ward_code as ward_code,&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; inpat_episode_details.acuity as acuity&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; FROM inpat_episode_details, inpat_admissions WHERE&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; inpat_episode_details.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_admissions.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; AND inpat_episode_details.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_admissions.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND inpat_episode_details.episode_no =  inpat_admissions.episode_no&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">wardCode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">ward_code</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">wardCode</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">checkDistributionCode</span><span class="p">(</span><span class="n">distributionCode</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">wardCode</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT inpat_episode_details.episode_no as episode_no, inpat_episode_details.acuity as acuity&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; FROM inpat_episode_details, inpat_admissions WHERE&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; inpat_episode_details.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_admissions.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; AND inpat_episode_details.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_admissions.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND inpat_episode_details.episode_no =  inpat_admissions.episode_no&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">if</span> <span class="n">distributionCode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">distributionCode</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.ipdischarges" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">ipdischarges</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on inpatient discharges</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ipdischarges</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on inpatient discharges</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT inpat_episode_details.episode_no as episode_no, inpat_episode_details.discharge_ward_code as ward_code,&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; inpat_episode_details.acuity as acuity&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; FROM inpat_episode_details, inpat_discharges WHERE&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; inpat_episode_details.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_discharges.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; AND inpat_episode_details.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_discharges.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND inpat_episode_details.episode_no =  inpat_discharges.episode_no&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">wardCode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">ward_code</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">wardCode</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">checkDistributionCode</span><span class="p">(</span><span class="n">distributionCode</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">wardCode</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT inpat_episode_details.episode_no as episode_no, inpat_episode_details.acuity as acuity&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; FROM inpat_episode_details, inpat_discharges WHERE&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; inpat_episode_details.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_discharges.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; AND inpat_episode_details.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_discharges.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND inpat_episode_details.episode_no =  inpat_discharges.episode_no&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">if</span> <span class="n">distributionCode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">distributionCode</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.ipwardbdays" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">ipwardbdays</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on days in an inpatient ward</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ipwardbdays</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on days in an inpatient ward</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT inpat_episode_details.episode_no as episode_no, inpat_patient_location.location_seq as event_seq, inpat_patient_location.ward_code as ward_code,&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; inpat_patient_location.ward_days as ward_days, inpat_patient_location.acuity as acuity&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; FROM inpat_episode_details, inpat_patient_location WHERE&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; inpat_episode_details.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_patient_location.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; AND inpat_episode_details.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_patient_location.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND inpat_episode_details.episode_no =  inpat_patient_location.episode_no&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_seq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">event_seq</span>
            <span class="n">wardCode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">ward_code</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">wardCode</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">checkDistributionCode</span><span class="p">(</span><span class="n">distributionCode</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">wardCode</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">ward_days</span> <span class="o">*</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT inpat_episode_details.episode_no as episode_no,&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; sum(inpat_patient_location.ward_days * inpat_patient_location.acuity) as eventWeight&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; FROM inpat_episode_details, inpat_patient_location WHERE&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; inpat_episode_details.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_patient_location.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; AND inpat_episode_details.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_patient_location.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND inpat_episode_details.episode_no =  inpat_patient_location.episode_no&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; GROUP BY inpat_episode_details.episode_no&#39;</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">if</span> <span class="n">distributionCode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">distributionCode</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">eventWeight</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.ipwardbhrs" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">ipwardbhrs</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based hours in an inpatient ward</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ipwardbhrs</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based hours in an inpatient ward</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT inpat_episode_details.episode_no as episode_no, inpat_patient_location.location_seq as event_seq, inpat_patient_location.ward_code as ward_code,&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; inpat_patient_location.ward_hours as ward_hours, inpat_patient_location.acuity as acuity&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; FROM inpat_episode_details, inpat_patient_location WHERE&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; inpat_episode_details.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_patient_location.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; AND inpat_episode_details.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_patient_location.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND inpat_episode_details.episode_no =  inpat_patient_location.episode_no&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_seq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">event_seq</span>
            <span class="n">wardCode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">ward_code</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">wardCode</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">checkDistributionCode</span><span class="p">(</span><span class="n">distributionCode</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">wardCode</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">ward_hours</span> <span class="o">*</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT inpat_episode_details.episode_no as episode_no,&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; sum(inpat_patient_location.ward_hours * inpat_patient_location.acuity) as eventWeight&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; FROM inpat_episode_details, inpat_patient_location WHERE&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; inpat_episode_details.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_patient_location.hospital_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">hospital_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39; AND inpat_episode_details.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot; AND inpat_patient_location.run_code = &quot;</span><span class="si">{</span><span class="n">d</span><span class="o">.</span><span class="n">run_code</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND inpat_episode_details.episode_no =  inpat_patient_location.episode_no&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; GROUP BY inpat_episode_details.episode_no&#39;</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">if</span> <span class="n">distributionCode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">distributionCode</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">eventWeight</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.ipwardsday" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">ipwardsday</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on a same day attendance in an inpatient ward</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">ipwardsday</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on a same day attendance in an inpatient ward</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no, admitting_ward_code, acuity FROM inpat_episode_details WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
    <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND same_day = 1&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
    <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
        <span class="n">wardCode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">admitting_ward_code</span>
        <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ward&#39;</span><span class="p">):</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">wardCode</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
            <span class="n">checkDistributionCode</span><span class="p">(</span><span class="n">distributionCode</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">wardCode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">code</span>
            <span class="k">if</span> <span class="n">distributionCode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">distributionCode</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
        <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
        <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.opclinicmin" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">opclinicmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on minutes in an outpatient clinic</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">opclinicmin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on minutes in an outpatient clinic</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;service_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Clinic&#39;</span>
    <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;clinic&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no, attend_min, clinic_code, acuity FROM clinic_activity_details WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">clinicCode</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">clinic_code</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">clinicCode</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="k">if</span> <span class="n">distributionCode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">distributionCode</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
            <span class="n">thisAcuity</span> <span class="o">=</span> <span class="n">adjustAcuity</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">acuity</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">attend_min</span> <span class="o">*</span> <span class="n">thisAcuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no, sum(attend_min * acuity) as eventWeight FROM clinic_activity_details WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; GROUP BY episode_no&#39;</span>
        <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
            <span class="n">distributionCode</span> <span class="o">=</span> <span class="n">code</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;distribution_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">distributionCode</span>
            <span class="k">if</span> <span class="n">distributionCode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">distributionCode</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
            <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">eventWeight</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
            <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
                <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="build_events_functions.theatremin" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">theatremin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">)</span></code>

</h3>


  <div class="doc doc-contents ">
  
      <p>Build events based on minutes in an operating theatre</p>

          <details class="quote">
            <summary>Source code in <code>build_events_functions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">theatremin</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">where</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">acuityScaling</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Build events based on minutes in an operating theatre</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">code</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">]:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s1">&#39;distribution code(</span><span class="si">%s</span><span class="s1">) not in distribution_codes(</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">codeTables</span><span class="p">[</span><span class="s1">&#39;distribution_codes&#39;</span><span class="p">])</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">EX_CONFIG</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">baseParams</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">what</span><span class="p">)</span>
    <span class="n">selectText</span> <span class="o">=</span> <span class="s1">&#39;SELECT episode_no, surgery_seq, theatre_mins, theatre_acuity FROM inpat_theatre_details WHERE &#39;</span> <span class="o">+</span> <span class="n">SQLwhereRun</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">where</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">where</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">selectText</span> <span class="o">+=</span> <span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="n">where</span>
    <span class="n">events_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">selectText</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">events_df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;episode_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">episode_no</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_seq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">surgery_seq</span>
        <span class="n">thisWeight</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">theatre_mins</span> <span class="o">*</span> <span class="n">row</span><span class="o">.</span><span class="n">theatre_acuity</span><span class="p">)</span> <span class="o">*</span> <span class="n">weight</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;event_weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisWeight</span>
        <span class="k">with</span> <span class="n">d</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../theDatabase/" title="The Database design" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                The Database design
              </div>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>